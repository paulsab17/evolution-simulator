---
title: "Population Evolution Simulator"
author: "Paul Sabharwal"
runtime: shiny
output: html_document
---

```{r, include = F}
library(tidyverse)
library(shiny)
library(gifski)
library(gganimate)
```




```{r shiny-input,echo=F}
fluidRow(
  column(6,
         numericInput("gens","number of generations",100,width = "auto")),
  column(6,
         sliderInput("pA0", label = "p(A):",
              min = 0, max = 1, value = 0.5, step = 0.001,width = "auto"))
)
fluidRow(
  column(4,
         numericInput("fitAA","fitness of AA (full armor)",1,width = "auto")),
  column(4,
         numericInput("fitAa","fitness of Aa (partial armor)",1,width = "auto")),
  column(4,
         numericInput("fitaa","fitness of aa (minimal armor)",1,width = "auto"))
)
```

```{r calc-1,echo=F}
next_gen <- function(gen_table,fAA,fAa,faa){
  
  num <- nrow(gen_table)
  
  last <- gen_table %>% slice(num)
  
  old_AA <- last %>% pull(AA)
  old_Aa <- last %>% pull(Aa)
  old_aa <- last %>% pull(aa)
  
  new_AA <- old_AA * fAA
  new_Aa <- old_Aa * fAa
  new_aa <- old_aa * faa
  total <- new_AA + new_Aa + new_aa
  new_AA <- new_AA / total
  new_Aa <- new_Aa / total
  new_aa <- new_aa / total
  
  new_pA <- (2*new_AA + new_Aa) / 2
  
  new_AA <- new_pA^2
  new_Aa <- 2*new_pA*(1-new_pA)
  new_aa <- (1-new_pA)^2
  
  old_gen <- last %>% pull(Gen)
  new_table <- gen_table %>%
    add_row(Gen = old_gen+1, AA = new_AA, Aa = new_Aa, aa = new_aa,pA = new_pA)
  return(new_table)
}
```


```{r shiny-render-1,echo=F}
renderImage({
  init_A <- input$pA0
  init_AA <- init_A^2
  init_Aa <- 2*init_A*(1-init_A)
  init_aa <- (1-init_A)^2

  fit_AA <- input$fitAA
  fit_Aa <- input$fitAa
  fit_aa <- input$fitaa
  
  num_gens <- input$gens
  
  gen_table <- tibble("Gen"=0,"AA"=init_AA,"Aa"=init_Aa,"aa"=init_aa,"pA"=init_A)
  
  for(i in 1:num_gens){
    gen_table <- next_gen(gen_table,fit_AA,fit_Aa,fit_aa)
  }
  
  p <- ggplot(gen_table,aes(Gen,pA)) +
    geom_line(color="red")+
    ylim(0,1) + 
    labs(y = "proportion of A alleles",x="Generation",title="Change in proportion of A allele over time") +
    theme_gray(base_size = 16) +
    transition_reveal(Gen)
  
  outfile <- tempfile(fileext='.gif')
  
  anim_save("outfile.gif",animate(p,nframes=25,end_pause=10,width=900))

    # Return a list containing the filename
  list(src = "outfile.gif",contentType = 'image/gif')
  
},deleteFile = TRUE
)
```


